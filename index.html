<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> </title>
  <link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/prism/1.30.0/plugins/line-numbers/prism-line-numbers.min.css">
  <link rel="stylesheet" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/prism/1.30.0/themes/prism.min.css">
  <link rel="stylesheet" id="theme-link" href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/prism/1.30.0/themes/prism.min.css">
  <link rel="stylesheet" href="index-ai.css">
</head>
<body>
  <div id="app" v-cloak>
    <div class="sidebar" :class="{ hidebar: !showSidebar }">
      <div class="side-setting">
        <div class="theme-toggle" @click="isDarkMode = !isDarkMode">{{ isDarkMode ? 'ğŸŒ™' : 'â˜€ï¸' }}</div>
        <div class="setting-icon" title="è®¾ç½®" onclick="location.href = './setting.html'">âš™ï¸</div>
        <div class="setting-icon icon-ai" title="å…¶ä»–AIç½‘ç«™" onclick="window.open('./ai.html')">ğŸŒ</div>
        <div class="setting-icon" v-show="chatSyncCode" :class="{ rotating: syncing }" title="æ‰‹åŠ¨ä¸Šä¼ èŠå¤©è®°å½•, é»˜è®¤10ç§’åŒæ­¥ä¸€æ¬¡" @click="syncChat">â™»</div>
      </div>
      <div class="sidebar-header">
        <select v-model="config.provider" @change="providerChange" placeholder="é€‰æ‹©æœåŠ¡å•†">
          <option v-for="provider in providers" :key="provider.name" :value="provider.name">{{ provider.name }}</option>
        </select>
        <select v-model="config.model" placeholder="é€‰æ‹©æ¨¡å‹">
          <option v-for="model in currModels" :key="model" :value="model">{{ model }}</option>
        </select>
        <select v-model="config.theme" placeholder="é€‰æ‹©ä»£ç ä¸»é¢˜">
          <option v-for="theme in themes" :key="theme" :value="theme">{{ theme }}</option>
        </select>
        <select v-model="config.prompt" placeholder="é€‰æ‹©ç³»ç»ŸåŠ©æ‰‹">
          <option value="">é€‰æ‹©ç³»ç»ŸåŠ©æ‰‹</option>
          <option v-for="(item, ind) in prompts" :key="ind" :value="item.id">{{ item.name }}</option>
        </select>
        <button @click="createNewChat">+æ–°å¯¹è¯</button>
      </div>
      <div class="history">
        <div v-for="(chat, index) in chatHistory" :key="chat.id" class="history-item"
          :class="{ active: chat.id === currentChatId }" @click="selectChat(chat.id)" @dblclick="renameChat(chat)">
          <a class="history-item-title" href="javascript:void(0);" :title="chat.title">{{ chat.title }}</a>
          <button @click.stop="deleteChat(chat.id)" class="delete-chat">Ã—</button>
        </div>
      </div>
    </div>
    <div class="chat-container" @click="showSidebar = false">
      <div class="chat-messages" ref="chatMessages" @click="handleChatClick">
        <div v-for="(message, index) in currentChatMessages" :key="index" :id="'curr-chat-' + index" class="message-wrapper" :class="message.role">
          <div class="avatar">{{ message.role === 'user' ? 'U' : 'AI' }}</div>
          <div class="content">
            <div v-if="message.isError">
              <span>è¯·æ±‚å¤±è´¥, è¯·æ‰“å¼€è°ƒè¯•çª—å£æŸ¥çœ‹é”™è¯¯ä¿¡æ¯.</span>
              <button class="retry-btn" @click="retryLastMessage">é‡è¯•</button>
            </div>
            <div v-else-if="message.role === 'user'" 
              class="prose" 
              :class="[message.role, 'msg_' + (message.id || 'u')]" 
              :style="{ fontSize: (config.fontSize || 16) + 'px' }">{{ message.content }}</div>
            <div v-else
              class="prose" 
              :class="[message.role, 'msg_' + (message.id || 'm')]" 
              :style="{ fontSize: (config.fontSize || 16) + 'px' }" 
              v-html="renderMarkdown(message.content, message.role === 'user')"></div>
            <div v-if="isStreaming && index === currentChatMessages.length - 1" class="pulse-dots"><i></i><i></i><i></i></div>
            <div v-if="!message.isError" class="message-actions">
              <button v-show="message.content" class="action-btn" @click="e => copyToClipboard(message.content, e.target)">å¤åˆ¶</button>
              <button v-if="message.role === 'assistant' && index === currentChatMessages.length - 1" class="action-btn" @click="retryLastMessage">é‡è¯•</button>
              <button v-if="message.role === 'user'" class="action-btn" @click="userInput = message.content">é‡é—®</button>
              <button v-if="message.role === 'user'" class="action-btn" @click="delMessage(message, index)">åˆ é™¤</button>
              <div v-if="message.tokenCount" class="token-count"><span v-if="message.remark">æ¨¡å‹: {{ message.remark }} </span> é•¿åº¦: {{ message.tokenCount }}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="chat-input-area">
        <div class="input-before" title="æ”¯æŒä¸Šä¸‹æ–‡, æ¶ˆè€—æ›´å¤štoken" @click="useContext =! useContext">{{ useContext ? 'ğŸŸ¢' : 'ğŸ”´' }}</div>
        <div class="chat-input-wrapper">
          <textarea v-model="userInput" class="chat-input" @keydown.enter="handleEnter"
            placeholder="è¾“å…¥æ¶ˆæ¯æé—®...(Shift+Enter æ¢è¡Œ)" rows="1"></textarea>
          <button v-if="userInput" class="send-btn del" @click="userInput = ''">âœ–</button>
          <button v-if="!isStreaming" class="send-btn" @click="sendMessage">â¤</button>
          <button v-if="isStreaming" class="stop-btn" @click="stopStream">â– </button>
        </div>
        <div class="to-top auto-scroll" :class="{ opacity: autoScroll }" @click="autoScroll = !autoScroll" title="è§£é™¤è‡ªåŠ¨æ»šåŠ¨åº•éƒ¨">â‡…</div>
        <div class="to-top" @click="scrollToBottom(true)" @dblclick="goTop" title="å•å‡»åˆ°åº•éƒ¨, åŒå‡»å›é¡¶éƒ¨">â‡©</div>
      </div>
      <div class="toggle-side" @click.stop="showSidebar = !showSidebar">ğŸ“°</div>
    </div>
    <div class="chat-nav">
      <div class="nav-item line1" v-for="(message, ind) in currentChatMessages" :key="ind">
          <span v-if="message.role === 'user'" @click="scrollToChat(ind)" :title="message.content"><i>â¤</i>{{ message.content }}</span>
          <span v-if="message.role !== 'user' && message.dir && message.dir.length">
            <b v-for="(d, din) in message.dir" @click="scrollToChatDir(message, d)" :title="d.c" :key="din" class="line1"><i>â¤</i>{{ d.c }}</b>
          </span>
      </div>
    </div>
    <div class="dialog" v-show="dialogShow" @click.self="dialogShow = false">
      <div class="dialog-cont"><textarea  v-model="dialogCont"></textarea></div>
    </div>
  </div>

  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/vue/3.5.17/vue.global.prod.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/marked/16.0.0/lib/marked.umd.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/prism/1.30.0/prism.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/prism/1.30.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/prism/1.30.0/components/prism-java.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/prism/1.30.0/components/prism-bash.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/prism/1.30.0/components/prism-batch.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/prism/1.30.0/components/prism-go.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/prism/1.30.0/components/prism-python.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/prism/1.30.0/components/prism-sql.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <!-- <script src="index.js"> </script> -->
  <script src="dist.min.js"></script>
  <script src="index-ai.js"></script>
</body>
</html>
